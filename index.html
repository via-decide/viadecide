    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Decide Engine | Neutral ONDC Product Discovery</title>
    <meta name="description" content="A neutral, logic-based decision engine for Smartphones, Audio, and Research. No ads, just data-driven comparisons for the ONDC era.">
    <meta name="keywords" content="ONDC, Smartphone Finder, Neutral Review, Decide Engine, Best Phone 2026, Decision Fatigue">
    <meta name="author" content="Decide OS">
    <link rel="canonical" href="https://viadecide.com/">

    <meta property="og:title" content="Decide Engine | Stop Searching, Start Deciding">
    <meta property="og:description" content="Swipe up to decide. A neutral engine that compares products based on YOUR priorities, not ads.">
    <meta property="og:image" content="https://viadecide.com/icon.png"> 
    <meta property="og:url" content="https://viadecide.com">
    <meta property="og:type" content="website">

    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Decide Engine",
      "url": "https://viadecide.com",
      "applicationCategory": "ShoppingApplication",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "INR"
      },
      "featureList": "Neutral Comparisons, ONDC Integration, Logic Reports"
    }
    </script>

    <style>
        /* VISUAL CORE v94.1 */
        :root{--brand-orange:#ff671f;--brand-dark:#050505;--glass-surface:rgba(20,20,20,0.85);--glass-border:rgba(255,255,255,0.15);--text-main:#fff;--accent-go:#00e676;--font-ui:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;--ease-elastic:cubic-bezier(0.19,1,0.22,1)}
        html,body{margin:0;padding:0;height:100%;width:100%;background-color:var(--brand-dark);color:var(--text-main);font-family:var(--font-ui);overflow:hidden;touch-action:none;-webkit-font-smoothing:antialiased}
        .aurora-bg{position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 50% 50%,#1a1a2e 0%,#000000 70%);z-index:-1;animation:drift 25s infinite alternate ease-in-out;opacity:0.8;pointer-events:none;will-change:transform}
        @keyframes drift{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(-20px,-20px,0) scale(1.05)}}
        #master-container{height:100vh;width:100vw;position:relative;overflow:hidden}
        .main-slide{height:100vh;width:100vw;position:absolute;top:0;left:0;display:flex;flex-direction:column;transition:transform 0.5s var(--ease-elastic),opacity 0.4s ease;background:transparent}
        .main-slide.prev{transform:translateY(-100%) scale(0.95);opacity:0;pointer-events:none}.main-slide.active{transform:translateY(0) scale(1);opacity:1;z-index:10;pointer-events:auto}.main-slide.next{transform:translateY(100%) scale(0.95);opacity:0;z-index:20;pointer-events:none}
        .slide-header{padding:0 24px;height:70px;display:flex;align-items:center;justify-content:space-between;position:absolute;top:0;left:0;right:0;z-index:100;background:linear-gradient(180deg,rgba(0,0,0,0.9) 0%,rgba(0,0,0,0) 100%);pointer-events:none}.slide-header>*{pointer-events:auto}
        .header-title{font-family:'Courier New',monospace;font-size:0.7rem;color:var(--brand-orange);letter-spacing:2px;font-weight:700;background:rgba(255,103,31,0.1);padding:6px 12px;border-radius:4px;border:1px solid rgba(255,103,31,0.2);display:flex;align-items:center;gap:8px}
        .status-dot{width:6px;height:6px;background:var(--accent-go);border-radius:50%;box-shadow:0 0 5px var(--accent-go);transition:background 0.3s}.status-dot.offline{background:#ff3333;box-shadow:0 0 5px #ff3333}
        .exit-btn{padding:8px 16px;border:1px solid rgba(255,255,255,0.3);border-radius:20px;background:rgba(0,0,0,0.6);color:#fff;font-size:0.7rem;font-weight:bold;cursor:pointer;backdrop-filter:blur(10px);text-transform:uppercase}
        .lobby-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:24px;margin-top:20px;overflow-y:auto;padding-bottom:120px;height:100%;align-content:start;padding-top:80px}
        .grid-btn{background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);border-radius:16px;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;aspect-ratio:1.15;transition:all 0.2s;cursor:pointer;backdrop-filter:blur(10px)}
        .grid-btn:active{transform:scale(0.96);background:rgba(255,255,255,0.08)}.grid-icon{font-size:1.8rem}.grid-label{font-weight:700;font-size:0.85rem;color:#fff;text-align:center}.grid-status{font-family:'Courier New',monospace;font-size:0.6rem;color:var(--accent-go);opacity:0.8;letter-spacing:1px}.full-width-btn{grid-column:span 2;aspect-ratio:auto;padding:18px;flex-direction:row;gap:15px}
        .btn-fuel { border-color: var(--brand-gold); background: rgba(255, 183, 0, 0.05); }
        .carousel-viewport{position:relative;flex-grow:1;width:100%;height:100%;margin-top:70px;perspective:1000px}
        .sub-slide{position:absolute;inset:20px;bottom:100px;padding:30px;display:flex;flex-direction:column;justify-content:center;background:var(--glass-surface);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:24px;opacity:0;pointer-events:none;transform:translateY(20px) scale(0.95);transition:all 0.4s var(--ease-elastic);box-shadow:0 20px 50px rgba(0,0,0,0.5)}.sub-slide.opt-active,.sub-slide.static{opacity:1;pointer-events:auto;transform:translateY(0) scale(1);z-index:30}.sub-slide.opt-hidden{opacity:0;pointer-events:none;transform:translateY(-20px) scale(0.95)}
        h1{font-size:2rem;font-weight:700;margin:0 0 15px 0;line-height:1.1;background:linear-gradient(to right,#fff,#ccc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .role-label{font-family:'Courier New',monospace;font-size:0.65rem;color:var(--brand-orange);margin-bottom:10px;display:flex;align-items:center;gap:8px;font-weight:700;letter-spacing:1px}.role-label::before{content:'';width:8px;height:8px;background:var(--brand-orange);border-radius:50%;box-shadow:0 0 10px var(--brand-orange)}
        .nav-hint{margin-top:25px;border-top:1px solid rgba(255,255,255,0.1);padding-top:15px;display:flex;justify-content:space-between;font-family:'Courier New',monospace;font-size:0.7rem;color:#555}.skip-btn-clickable{cursor:pointer;padding:6px 12px;background:rgba(255,255,255,0.1);border-radius:20px;font-weight:bold;color:#aaa}
        .cuisine-btn{background:rgba(20,20,20,0.6);border:1px solid var(--glass-border);color:#888;padding:20px;font-size:1rem;font-weight:600;border-radius:12px;transition:all 0.3s;width:100%;text-align:left;margin-bottom:10px}.cuisine-btn.selected{background:rgba(255,103,31,0.15);color:var(--brand-orange);border-color:var(--brand-orange)}
        .btn{background:rgba(255,255,255,0.05);color:#fff;border:1px solid rgba(255,255,255,0.1);padding:18px;border-radius:12px;font-weight:600;cursor:pointer;width:100%;margin-top:15px}.btn-primary{background:var(--brand-orange);color:#000;border:none;font-weight:800}
        .search-wrapper{position:relative;margin-bottom:20px}#search-input{width:100%;padding:20px;border-radius:16px;border:1px solid var(--glass-border);background:rgba(0,0,0,0.3);color:#fff;font-size:1.1rem}
        .toast-msg{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:#111;color:var(--accent-go);border:1px solid #333;padding:12px 24px;border-radius:30px;opacity:0;transition:opacity 0.3s;font-family:'Courier New',monospace;z-index:9999;font-weight:bold;pointer-events:none}.toast-msg.visible{opacity:1}
        .video-bg{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;opacity:0.4;mix-blend-mode:screen}.winner-container{flex-grow:1;display:flex;flex-direction:column;justify-content:flex-end;padding:30px;padding-bottom:120px;background:linear-gradient(to top,#000 95%,transparent)}
        .wiki-summary{max-height:250px;overflow-y:auto;color:var(--text-muted);line-height:1.5;margin-bottom:10px}.topic-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:20px}.topic-card{background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);padding:15px;border-radius:12px;cursor:pointer}.topic-title{font-weight:bold;font-size:0.85rem;margin-bottom:4px;font-family:'Courier New',monospace}.topic-desc{font-size:0.75rem;color:#888}
        #share-card-canvas{position:fixed;top:-200vh;left:0;width:360px;padding:40px 30px;background:linear-gradient(145deg,#111,#050505);border:2px solid var(--brand-orange);border-radius:24px;text-align:center;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9000}
        iframe{width:100%;height:100%;border:none;background:#000}.close-iframe{position:fixed;top:20px;right:20px;z-index:200;background:#000;border:1px solid #333;color:#fff;padding:10px 20px;border-radius:20px;font-weight:bold;cursor:pointer}
        .deal-tag{color:var(--accent-go);font-size:0.8rem;font-weight:bold;background:rgba(0,230,118,0.1);padding:2px 6px;border-radius:4px;margin-left:10px;font-family:'Courier New',monospace}
        .final-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;width:100%}
    </style>
</head>
<body>
<div class="aurora-bg"></div><div id="master-container"></div><div id="toast" class="toast-msg"></div>
<div id="share-card-canvas">
    <div style="font-family:'Courier New';color:var(--brand-orange);font-size:0.8rem;letter-spacing:2px;margin-bottom:20px;">DECIDE ENGINE</div>
    <div style="font-size:0.7rem;color:#888;text-transform:uppercase;">THE WINNER IS</div>
    <h1 id="share-winner-name" style="font-size:2.5rem;margin:15px 0;line-height:1;color:#fff;word-wrap:break-word;">WINNER</h1>
    <div id="share-winner-price" style="font-size:1.5rem;color:var(--accent-go);font-weight:bold;">‚Çπ0</div>
    <div style="margin-top:30px;font-size:0.7rem;color:#666;border-top:1px solid #333;padding-top:15px;width:100%;">viadecide.com</div>
</div>

<script>
    /* DECIDE OS v94.1 | COMMERCIAL CORE */
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzT3MWODY9r0UlyBscZtr5BdF_upkjrpcng7xl07WsAixLTwKxIKWEoXEwhDoGTOIDk/exec"; 
    const PHONE_REVIEW_URL = "https://youtu.be/W28-2z9IZbA?si=nJDuPcmTsaUcao9d";
    const AUDIO_REVIEW_URL = "https://youtu.be/ceuEz96MMEY";
    const YOUTUBE_CHANNEL = "https://www.youtube.com/@decide.engine"; 
    
    // --- 1. AFFILIATE ENGINE ---
    const AMZN_TAG = "decideos-21"; 
    function openAffiliate(query) {
        if(!query) return showToast("INVALID LINK");
        const url = `https://www.amazon.in/s?k=${encodeURIComponent(query)}&tag=${AMZN_TAG}&linkCode=ll2`;
        window.open(url, '_blank');
    }

    const WINNER_VIDEO = "https://static.videezy.com/system/resources/previews/000/012/628/original/Abstract_Blue_Background.mp4";
    let PHONE_DB = {}, AUDIO_DB = {}, ENGINE_STATE = { currentDomain: null, items_detected: {}, active_filters: [], session_weights: {}, researchPath: [], triviaMode: false, sessionID: "", DECISION_LOG: null };
    let slideElements = [], currentIdx = 0;

    const MODULES = {
        smartphones: { label: "SMARTPHONES", database: PHONE_DB, review: PHONE_REVIEW_URL, init: () => renderEcosystemGate(), 
            categories: [{label:"CAMERA-FIRST", type:"cam", items:[]}, {label:"PRO GAMER", type:"gam", items:[]}, {label:"CLEAN UI", type:"ui", items:[]}, {label:"BATTERY KING", type:"bat", items:[]}] },
        earbuds: { label: "EARBUDS", database: AUDIO_DB, review: AUDIO_REVIEW_URL, init: () => { ENGINE_STATE.active_filters=[]; renderSubLobby('earbuds'); }, 
            categories: [{label:"AUDIOPHILE", type:"snd", items:[]}, {label:"SILENCE (ANC)", type:"anc", items:[]}, {label:"LOW LATENCY", type:"lat", items:[]}] },
        trivia: { label: "TRIVIA", init: () => renderTriviaGate() },
        research: { label: "RESEARCH", init: () => renderSearchSlide() },
        food: { label: "DINING", init: () => renderExternalModule("https://via-decide.github.io/food.decider/") },
        custom: { label: "CUSTOM REQ", init: () => renderExternalModule("https://via-decide.github.io/food.decide-custom/") },
        review: { label: "ENGINE REVIEW ‚Üó", init: () => window.open(YOUTUBE_CHANNEL, '_blank') }
    };

    const DEAL_BREAKERS = { "CLEAN UI": "bloatware", "LIGHTWEIGHT": "heavy", "FAST CHARGE": "slow_charge" };
    const CURATED_PATHS = {"THE BIG BANG": {title:"The Big Bang",summary:"The prevailing cosmological model.",links:["Cosmic Inflation"]}, "SYSTEMS THINKING": {title:"Systems Thinking",summary:"A holistic approach to analysis.",links:["Feedback Loops"]}};
    const VOICE_FEED = [{id:"voice_focus_ai",title:"Voice Focus AI",mode:"explain",blocks:[{text:"Voice Focus AI uses a six-microphone array."}]},{id:"earbuds_buy_wait",title:"Earbuds Guide",mode:"decision",blocks:[{text:"Buy Technics AZ100 for work. Wait for Sony."}]}];

    const WIKI_ENGINE = {
        async resolveTitle(q){try{const r=await fetch(`https://en.wikipedia.org/w/api.php?origin=*&action=opensearch&search=${encodeURIComponent(q)}&limit=1&format=json`);const d=await r.json();return d[1]?.[0]||null}catch(e){return null}},
        async buildKnowledgeNode(q){if(CURATED_PATHS[q.toUpperCase()]){const c=CURATED_PATHS[q.toUpperCase()];return{title:c.title,summary:c.summary,description:"Curated Node",links:c.links.map(l=>({name:l}))}}const t=await this.resolveTitle(q);if(!t)return null;try{const[s,l]=await Promise.all([fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(t)}`).then(r=>r.json()),fetch(`https://en.wikipedia.org/w/api.php?origin=*&action=query&prop=links&titles=${encodeURIComponent(t)}&pllimit=20&format=json`).then(r=>r.json())]);const p=Object.keys(l.query.pages)[0];return{title:s.title,summary:s.extract,description:"Research Topic",links:(l.query.pages[p].links||[]).slice(0,5).map(x=>({name:x.title}))}}catch(e){return null}}
    };
    const TRIVIA_ENGINE = {async fetch(cat=""){try{const r=await fetch(`https://opentdb.com/api.php?amount=5&type=multiple${cat?'&category='+cat:''}`);const d=await r.json();return d.results||[]}catch(e){return[]}}};

    async function syncDatabase(){
        showToast("SYNCING...");
        try{
            const r=await fetch(`${BACKEND_URL}?type=local`);const d=await r.json();PHONE_DB={};AUDIO_DB={};
            d.forEach(i=>{
                const e={attr:{cam:Number(i.cam)||0,gam:Number(i.gam)||0,bat:Number(i.bat)||0,ui:Number(i.ui)||0,dis:Number(i.dis)||0,srv:Number(i.srv)||0,thm:Number(i.thm)||0,dur:Number(i.dur)||0},tags:i.tags?i.tags.split(',').map(t=>t.trim()):[],price:Number(i.price)||0,mrp:Number(i.mrp)||0};
                if(i.category==='smartphones')PHONE_DB[i.Name]=e;if(i.category==='earbuds')AUDIO_DB[i.Name]=e;
            });
            MODULES.smartphones.database=PHONE_DB;MODULES.earbuds.database=AUDIO_DB;
            showToast("DB LIVE ‚úÖ");updateStatus(true);
        }catch(e){console.error(e);showToast("OFFLINE MODE");updateStatus(false)}
    }

    function injectProductSchema(winner) {
        const old = document.getElementById('dynamic-schema'); if(old) old.remove();
        const schema = { "@context": "https://schema.org/", "@type": "Product", "name": winner.name, "description": `Best choice for ${ENGINE_STATE.active_filters.join(', ')}`, "brand": { "@type": "Brand", "name": winner.name.split(' ')[0] }, "offers": { "@type": "Offer", "priceCurrency": "INR", "price": winner.price, "availability": "https://schema.org/InStock" } };
        const script = document.createElement('script'); script.id = "dynamic-schema"; script.type = 'application/ld+json'; script.text = JSON.stringify(schema); document.head.appendChild(script);
    }

    // --- REARRANGED LOBBY RENDERER (v94.1) ---
    function renderLobby() {
        const container = document.getElementById('master-container');
        container.innerHTML = "";
        const section = document.createElement('section');
        section.className = "main-slide active";
        section.innerHTML = `
            <div class="slide-header"><span class="header-title">DECIDE OS v94.1 <div class="status-dot"></div></span></div>
            <div class="lobby-grid">
                <div class="grid-btn btn-fuel" id="install-btn" style="display:none; border-color:#00e676;" onclick="installApp()">
                    <div class="grid-icon">üì≤</div>
                    <div class="grid-label">INSTALL APP</div>
                    <div class="grid-status">ADD TO HOME</div>
                </div>

                <div class="grid-btn" onclick="loadDomain('smartphones')"><div class="grid-icon">üì±</div><div class="grid-label">PHONES</div><div class="grid-status">LIVE DB</div></div>
                <div class="grid-btn" onclick="loadDomain('earbuds')"><div class="grid-icon">üéß</div><div class="grid-label">AUDIO</div><div class="grid-status">NEUTRAL</div></div>
                
                <div class="grid-btn" onclick="loadDomain('research')"><div class="grid-icon">üß†</div><div class="grid-label">RESEARCH</div><div class="grid-status">ONDC+</div></div>
                <div class="grid-btn" onclick="loadDomain('trivia')"><div class="grid-icon">üß©</div><div class="grid-label">TRIVIA</div><div class="grid-status">LOGIC</div></div>
                <div class="grid-btn" onclick="openVoiceLobby()"><div class="grid-icon">üéôÔ∏è</div><div class="grid-label">VOICE FEED</div><div class="grid-status">AI READY</div></div>
                
                <div class="grid-btn full-width-btn" onclick="loadDomain('review')"><div class="grid-icon">‚ñ∂</div><div class="grid-label">ENGINE REVIEW ‚Üó</div></div>
                <div style="grid-column:span 2;text-align:center;opacity:0.3;font-size:0.6rem;margin-top:20px;font-family:var(--font-tech);">SESSION: ${ENGINE_STATE.sessionID}</div>
            </div>`;
        container.appendChild(section);
        slideElements = [section];
        currentIdx = 0;
        let e = document.getElementById('global-exit'); if(e) e.remove();
    }

    function loadDomain(k){if((k==='smartphones'||k==='earbuds')&&Object.keys(MODULES[k].database).length===0){showToast("DB EMPTY. RETRYING...");syncDatabase().then(()=>{if(Object.keys(MODULES[k].database).length>0)proceedLoad(k);else showToast("SERVER ERROR")});}else proceedLoad(k);}
    function proceedLoad(k){ENGINE_STATE.currentDomain=k;const c=document.getElementById('master-container');while(c.children.length>1)c.removeChild(c.lastChild);slideElements=[slideElements[0]];addGlobalExit();MODULES[k].init()}
    function renderEcosystemGate(){const s=document.createElement('section');s.className="main-slide next";s.innerHTML=`<div class="slide-header"><span class="header-title">PHILOSOPHY</span></div><div class="lobby-container"><h1 style="text-align:center">WHAT MATTERS?</h1><div style="display:grid;gap:20px;margin-top:20px;"><button class="cuisine-btn" onclick="selectEcosystem('specs')">üöÄ PURE SPECS</button><button class="cuisine-btn" onclick="selectEcosystem('peace')">üõ°Ô∏è PEACE OF MIND</button></div></div>`;document.getElementById('master-container').appendChild(s);slideElements.push(s);goToSlide(1)}
    function selectEcosystem(t){ENGINE_STATE.ecosystem=t;ENGINE_STATE.active_filters=[];renderSubLobby('smartphones')}
    function renderSubLobby(d){const s=document.createElement('section');s.className="main-slide next";let h=`<div class="slide-header"><span class="header-title">FILTER</span></div><div class="lobby-container"><h1 style="text-align:center">PRIORITIES</h1><div style="display:grid;gap:10px;margin-top:20px;">`;MODULES[d].categories.forEach((c,i)=>{h+=`<button class="cuisine-btn" id="filter-btn-${i}" onclick="toggleFilter('${c.label}',${i})">${c.label}</button>`});h+=`</div><button class="btn btn-primary" style="margin-top:30px" onclick="startHunt()">HUNT ‚Üí</button></div>`;s.innerHTML=h;document.getElementById('master-container').appendChild(s);slideElements.push(s);goToSlide(slideElements.length-1)}
    function toggleFilter(l,i){const b=document.getElementById(`filter-btn-${i}`);if(ENGINE_STATE.active_filters.includes(l)){ENGINE_STATE.active_filters=ENGINE_STATE.active_filters.filter(x=>x!==l);b.classList.remove('selected')}else{ENGINE_STATE.active_filters.push(l);b.classList.add('selected')}}
    function startHunt(){if(ENGINE_STATE.active_filters.length===0)return showToast("SELECT AT LEAST ONE");ENGINE_STATE.session_weights={cam:0.1,gam:0.1,bat:0.1,ui:0.1,dis:0.1,srv:0.1,thm:0.1,dur:0.1,anc:0.1,snd:0.1,mic:0.1,lat:0.1};buildDeck()}

    function calculateVerdict(){
        let DB=MODULES[ENGINE_STATE.currentDomain].database;let c=[],eliminated=[];
        const banned=ENGINE_STATE.active_filters.map(f=>DEAL_BREAKERS[f.toUpperCase()]).filter(Boolean);
        for(let n in DB){
            let i=DB[n];
            if(i.tags&&i.tags.some(t=>banned.includes(t))){eliminated.push({name:n,reason:i.tags.find(t=>banned.includes(t))});continue}
            let s=0;
            if(ENGINE_STATE.ecosystem==='specs'&&(i.tags.includes('performance')||i.tags.includes('value')))s+=3;
            if(ENGINE_STATE.ecosystem==='peace'&&(i.tags.includes('trust')||i.tags.includes('premium')))s+=3;
            for(let a in i.attr)s+=i.attr[a]*(ENGINE_STATE.session_weights[a]||0.1);
            if(ENGINE_STATE.items_detected[n])s+=10;
            c.push({name:n,score:s,price:i.price,mrp:i.mrp,specs:i.attr});
        }
        c.sort((a,b)=>b.score-a.score);
        const w=c[0]||{name:"No Match",price:0,specs:{}};
        const r=c[1]||null;
        ENGINE_STATE.DECISION_LOG={winner:w,runner:r,eliminated:eliminated,priorities:ENGINE_STATE.active_filters,timestamp:new Date().toISOString()};
        return w;
    }

    function buildDeck(){
        const c=document.getElementById('master-container');
        const tc=MODULES[ENGINE_STATE.currentDomain].categories.filter(x=>ENGINE_STATE.active_filters.includes(x.label));
        const cats=tc.length>0?tc:[{label:"Balanced Choice"}];
        cats.forEach((cat,i)=>{const e=document.createElement('section');e.className="main-slide next";e.innerHTML=`<div class="slide-header"><span class="header-title">${cat.label}</span></div><div class="carousel-viewport"><div class="sub-slide opt-active" data-val="Generic Choice"><div class="role-label">PROPOSAL</div><h1>Best for ${cat.label}</h1><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT ‚Üë</span></div></div></div>`;c.appendChild(e);slideElements.push(e)});
        const f=document.createElement('section');f.className="main-slide next";
        f.innerHTML=`<video class="video-bg" autoplay loop muted playsinline><source src="${WINNER_VIDEO}" type="video/mp4"></video><div class="winner-container"><div id="final-list"></div><div class="final-actions"><button class="btn btn-primary" onclick="redirect()">CHECK PRICE ‚Üó</button><button class="btn btn-yt" onclick="openReview()">‚ñ∂ WATCH REVIEW</button><button class="btn btn-doc" onclick="generateDecisionReport()">üìÑ REPORT</button><button class="btn btn-share" onclick="generateShareCard()">üì∑ SHARE</button></div></div>`;
        c.appendChild(f);slideElements.push(f);goToSlide(currentIdx+1);
    }

    function updateFinal(){
        const l=document.getElementById('final-list');const w=calculateVerdict();const log=ENGINE_STATE.DECISION_LOG;
        const r=(log.priorities.length>0)?`Optimized for ${log.priorities.join(" + ")}`:"Balanced Performance Score";
        let p=`Est. ‚Çπ${w.price}`;if(w.mrp>w.price){const o=Math.round(((w.mrp-w.price)/w.mrp)*100);p=`‚Çπ${w.price} <span class="deal-tag">(${o}% OFF)</span>`}
        l.innerHTML=`<div style="text-align:left;"><span style="color:var(--accent-go);font-size:0.8rem;font-weight:bold;letter-spacing:2px;">THE NEUTRAL CHAMPION</span><div style="font-size:2.8rem;font-weight:900;margin:5px 0;color:#fff;line-height:1.1;">${w.name}</div><p style="color:var(--brand-orange);font-size:0.7rem;font-family:var(--font-tech);text-transform:uppercase;">${r}</p><p style="color:#eee;font-size:1.1rem;margin-top:5px;">${p}</p></div>`;
        fetch(BACKEND_URL,{method:'POST',body:JSON.stringify({event:"WINNER_FOUND",item:w.name,session_id:ENGINE_STATE.sessionID})});
        injectProductSchema(w);
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(`The winner is ${w.name}.`));
    }

    function generateDecisionReport(){
        const log=ENGINE_STATE.DECISION_LOG;
        if(!log)return showToast("NO DATA");
        const {jsPDF}=window.jspdf;const doc=new jsPDF();
        doc.setFillColor(20,20,20); doc.rect(0,0,210,297,'F');
        doc.setTextColor(255,103,31); doc.setFontSize(22); doc.text("DECIDE ENGINE AUDIT", 14, 20);
        doc.setTextColor(255,255,255); doc.setFontSize(10); doc.text(`SESSION ID: ${ENGINE_STATE.sessionID} | DATE: ${new Date().toLocaleDateString()}`, 14, 28);
        doc.line(14,32,196,32);
        doc.setFontSize(14); doc.setTextColor(0,230,118); doc.text("1. THE VERDICT", 14, 45);
        doc.setTextColor(255,255,255); doc.setFontSize(11);
        doc.text(`Winner: ${log.winner.name}`, 14, 53);
        doc.text(`Logic: This device scored highest based on your specific priorities:`, 14, 60);
        doc.text(`[ ${log.priorities.join(" + ")} ]`, 14, 66);
        let y=80;
        if(log.runner){
            doc.setTextColor(255,103,31); doc.setFontSize(14); doc.text("2. THE CLOSE CALL", 14, y);
            doc.setTextColor(200,200,200); doc.setFontSize(11); y+=8;
            const diff = Math.round(((log.winner.score - log.runner.score)/log.runner.score)*100);
            doc.text(`Runner Up: ${log.runner.name}`, 14, y); y+=6;
            doc.text(`Reasoning: The winner beat the ${log.runner.name} by a ${diff}% margin`, 14, y); y+=6;
            doc.text(`specifically in the attributes you care about most.`, 14, y); y+=15;
        }
        if(log.eliminated.length>0){
            doc.setTextColor(255,50,50); doc.setFontSize(14); doc.text("3. EXCLUDED OPTIONS (GRAVEYARD)", 14, y); y+=8;
            doc.setTextColor(200,200,200); doc.setFontSize(10);
            log.eliminated.slice(0,5).forEach(e=>{ doc.text(`- ${e.name}: Eliminated due to conflict '${e.reason}'`, 14, y); y+=6; }); y+=10;
        }
        const rows=[]; const wSpecs=log.winner.specs||{};
        const labels={cam:"Camera",gam:"Gaming",bat:"Battery",ui:"UI Cleanliness",dis:"Display",srv:"Service"};
        for(let k in wSpecs){if(labels[k])rows.push([labels[k], `${wSpecs[k]}/10`])}
        doc.autoTable({startY:y,head:[["Attribute","Score"]],body:rows,theme:'grid',headStyles:{fillColor:[255,103,31]},styles:{textColor:255,fillColor:[30,30,30]}});
        doc.save(`Audit_Report_${ENGINE_STATE.sessionID}.pdf`); showToast("AUDIT DOWNLOADED");
    }

    async function diveDeeper(t){showToast("FORGING NODE...");const n=await WIKI_ENGINE.buildKnowledgeNode(t);if(n){ENGINE_STATE.researchPath.push(n);buildResearchDeck(n)}else showToast("NO DATA FOUND")}
    async function renderSearchSlide(){const s=document.createElement('section');s.className="main-slide next";let h=`<div class="topic-grid">`+Object.keys(CURATED_PATHS).map(k=>`<div class="topic-card" onclick="document.getElementById('search-input').value='${k}';executeSearch()"><div class="topic-title">${CURATED_PATHS[k].title}</div></div>`).join('')+`</div>`;s.innerHTML=`<div class="slide-header"><span class="header-title">RESEARCH</span></div><div class="lobby-container"><h1>TOPIC?</h1><div class="search-wrapper"><input type="text" id="search-input" placeholder="e.g. Systems, AI..."></div><button class="btn btn-primary" onclick="executeSearch()">SEARCH ‚Üí</button>${h}</div>`;document.getElementById('master-container').appendChild(s);slideElements.push(s);goToSlide(1)}
    async function executeSearch(){const q=document.getElementById('search-input').value;if(!q)return showToast("ENTER TOPIC");showToast("SEARCHING...");fetch(BACKEND_URL,{method:'POST',body:JSON.stringify({event:"SEARCH_QUERY",query:q,session_id:ENGINE_STATE.sessionID})});try{const r=await fetch(`${BACKEND_URL}?type=search&q=${encodeURIComponent(q)}`);const d=await r.json();if(d.items){showToast("PRODUCTS FOUND!");}else{const n=await WIKI_ENGINE.buildKnowledgeNode(q);if(!n)return showToast("NOT FOUND");ENGINE_STATE.researchPath=[n];buildResearchDeck(n)}}catch(e){showToast("OFFLINE")}}
    
    function buildResearchDeck(c){const s=document.createElement('section');s.className="main-slide next";s.innerHTML=`<div class="slide-header"><span class="header-title">DEPTH: ${ENGINE_STATE.researchPath.length}</span><div style="display:flex;gap:10px"><button class="skip-btn-clickable" onclick="openAffiliate('${c.title}')">SHOP NODE ‚Üó</button></div></div><div class="carousel-viewport"><div class="sub-slide static"><div class="role-label">KNOWLEDGE NODE</div><h1>${c.title}</h1><div class="wiki-summary">${c.summary}</div><div class="nav-hint"><span>BACK</span><span>DIG DEEPER</span></div></div>${c.links.map(l=>`<div class="sub-slide opt-hidden" data-val="${l.name}"><div class="role-label">RELATED</div><h1>${l.name}</h1><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT ‚Üë</span></div></div>`).join('')}</div>`;document.getElementById('master-container').appendChild(s);slideElements.push(s);goToSlide(slideElements.length-1)}
    function renderTriviaGate(){const s=document.createElement('section');s.className="main-slide next";s.innerHTML=`<div class="slide-header"><span class="header-title">TRIVIA</span></div><div class="lobby-container"><h1 style="text-align:center">CATEGORY</h1><div style="display:grid;gap:15px;"><button class="cuisine-btn" onclick="startTrivia(9)">GENERAL</button><button class="cuisine-btn" onclick="startTrivia(18)">COMPUTERS</button><button class="cuisine-btn" onclick="startTrivia(17)">SCIENCE</button></div></div>`;document.getElementById('master-container').appendChild(s);slideElements.push(s);goToSlide(1)}
    async function startTrivia(c){showToast("FETCHING Qs...");const d=await TRIVIA_ENGINE.fetch(c);if(!d.length)return showToast("ERROR");const con=document.getElementById('master-container');d.forEach((q,i)=>{const e=document.createElement('section');e.className="main-slide next";const a=[...q.incorrect_answers,q.correct_answer].sort(()=>Math.random()-0.5);e.innerHTML=`<div class="slide-header"><span class="header-title">Q${i+1}</span></div><div class="carousel-viewport">${a.map((ans,idx)=>`<div class="sub-slide ${idx===0?'opt-active':'opt-hidden'}" data-correct="${ans===q.correct_answer}" data-real="${q.correct_answer}"><div class="role-label">${q.difficulty.toUpperCase()}</div><h1 style="font-size:1.4rem">${q.question}</h1><div style="margin-top:20px;font-size:1.2rem;color:var(--brand-orange)">${ans}</div><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT ‚Üë</span></div></div>`).join('')}</div>`;con.appendChild(e);slideElements.push(e)});goToSlide(slideElements.length-d.length)}
    function openVoiceLobby(){window.speechSynthesis.cancel();addGlobalExit();const s=document.createElement('section');s.className="main-slide next";s.innerHTML=`<div class="slide-header"><span class="header-title">VOICE MODULE</span></div><div class="lobby-container"><h1>VOICE FEEDS</h1><div class="topic-grid">${VOICE_FEED.map(v=>`<div class="topic-card" onclick="playVoice('${v.id}')"><div class="topic-title">${v.title}</div><div class="topic-desc">${v.mode}</div></div>`).join('')}</div></div>`;document.getElementById('master-container').appendChild(s);slideElements.push(s);goToSlide(1)}
    function playVoice(id){const f=VOICE_FEED.find(v=>v.id===id);if(f){window.speechSynthesis.speak(new SpeechSynthesisUtterance(f.blocks.map(b=>b.text).join('. ')));showToast("PLAYING...")}}
    function renderExternalModule(u){addGlobalExit();const s=document.createElement('section');s.className="main-slide next";s.innerHTML=`<iframe src="${u}"></iframe>`;document.getElementById('master-container').appendChild(s);slideElements.push(s);goToSlide(slideElements.length-1)}
    function showTutorial(){if(localStorage.getItem('tutorial_done'))return;const o=document.createElement('div');o.style="position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:#fff;";o.innerHTML=`<div style="font-size:3rem;margin-bottom:20px;">‚òùÔ∏è</div><h2>SWIPE UP TO SELECT</h2><p style="color:#888;">Swipe Down to go back</p><button class="btn btn-primary" style="width:auto;margin-top:30px;padding:12px 30px;" onclick="this.parentElement.remove();localStorage.setItem('tutorial_done',true);">GOT IT</button>`;document.body.appendChild(o)}
    async function generateShareCard(){const w=calculateVerdict();document.getElementById('share-winner-name').innerText=w.name;document.getElementById('share-winner-price').innerText="‚Çπ"+w.price;const c=document.getElementById('share-card-canvas');c.style.top="0";try{const cv=await html2canvas(c,{scale:2});c.style.top="-200vh";cv.toBlob(b=>{const f=new File([b],"Winner.png",{type:"image/png"});if(navigator.share)navigator.share({files:[f]});else{const l=document.createElement('a');l.download="Winner.png";l.href=cv.toDataURL();l.click()}})}catch(e){c.style.top="-200vh"}}
    function addGlobalExit(){if(!document.getElementById('global-exit')){const b=document.createElement('button');b.id='global-exit';b.className='exit-btn';b.innerText='EXIT';b.onclick=()=>renderLobby();b.style.position='fixed';b.style.top='20px';b.style.right='20px';b.style.zIndex='5000';document.body.appendChild(b)}}
    function goToSlide(i){if(i<0||i>=slideElements.length)return;slideElements[currentIdx].classList.replace('active',i>currentIdx?'prev':'next');currentIdx=i;slideElements[currentIdx].className="main-slide active";if(slideElements[currentIdx].querySelector('#final-list'))updateFinal()}
    function showToast(m){const t=document.getElementById('toast');t.innerText=m;t.classList.add('visible');setTimeout(()=>t.classList.remove('visible'),2000)}
    function updateStatus(i){const d=document.querySelector('.status-dot');if(d)i?d.classList.remove('offline'):d.classList.add('offline')}
    function manualSkip(e){const v=e.closest('.carousel-viewport');const a=v.querySelector('.sub-slide.opt-active');if(!a)return;const s=Array.from(v.querySelectorAll('.sub-slide:not(.static)'));const n=s[(s.indexOf(a)+1)%s.length];a.classList.replace('opt-active','opt-hidden');n.classList.replace('opt-hidden','opt-active')}
    
    // UPDATED: Now uses openAffiliate
    function redirect(){const i=Object.keys(ENGINE_STATE.items_detected)[0];if(!i)return showToast("SELECT ITEM"); openAffiliate(i); }
    
    let tsY=0;
    function initSwipeSystem(){document.addEventListener('touchstart',e=>tsY=e.touches[0].clientY,{passive:true});document.addEventListener('touchend',e=>{if(e.target.closest('.wiki-summary'))return;const v=e.target.closest('.main-slide.active .carousel-viewport');if(!v)return;const dy=e.changedTouches[0].clientY-tsY;const a=v.querySelector('.sub-slide.opt-active')||v.querySelector('.sub-slide.static');if(dy<-60){if(a.classList.contains('static')){a.classList.remove('static');a.classList.add('opt-hidden');v.querySelector('.sub-slide:nth-child(2)').classList.add('opt-active')}else if(ENGINE_STATE.triviaMode){if(a.dataset.correct==="true"){showToast("CORRECT! DIVING DEEPER...");setTimeout(()=>diveDeeper(a.dataset.real),800)}else showToast("WRONG!")}else if(a.dataset.val){if(ENGINE_STATE.currentDomain==='smartphones'||ENGINE_STATE.currentDomain==='earbuds'){ENGINE_STATE.items_detected[a.dataset.val]=true;goToSlide(currentIdx+1)}else diveDeeper(a.dataset.val)}}else if(dy>60){if(ENGINE_STATE.currentDomain==='research'&&ENGINE_STATE.researchPath.length>1){ENGINE_STATE.researchPath.pop();buildResearchDeck(ENGINE_STATE.researchPath[ENGINE_STATE.researchPath.length-1])}else goToSlide(currentIdx-1)}})}
    function boot(){ENGINE_STATE.sessionID="SID-"+Math.random().toString(36).substr(2,4).toUpperCase();syncDatabase();renderLobby();initSwipeSystem();showTutorial()}
    boot();

    // --- PWA INSTALLER ENGINE ---
    let deferredPrompt;
    if ('serviceWorker' in navigator) {navigator.serviceWorker.register('./sw.js').then(()=>console.log('SW Registered')).catch(err=>console.log('SW Error:',err));}
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; const btn = document.getElementById('install-btn'); if(btn) btn.style.display = 'flex'; });
    async function installApp() { if (!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') { deferredPrompt = null; document.getElementById('install-btn').style.display = 'none'; }}
</script>
</body>
</html>

